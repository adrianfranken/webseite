(function($){function getFittingItemsCount(widthAvailableForItems,itemsWidths){return itemsWidths.reduce(function(acc,width){var widthAcc=acc[0],count=acc[1];if(widthAcc+width>widthAvailableForItems){return[widthAcc+width,count]}return[widthAcc+width,count+1]},[0,0])[1]}function liToWidth(index,li){return $(li).width()}function removeSeparatorFromLastItem(lis){lis.last().find('div').remove()}function fixMoreButtons(){$('.moreEnabled').each(function(index,menu){var $menu=$(menu);$menu.css('display','');var $ul=$menu.children('ul'),$lis=$ul.children('ul > li'),lisWidths=$lis.map(liToWidth).toArray(),menuWidth=$menu.width(),moreBtnIndex=lisWidths.length-1,moreBtnWidth=lisWidths[moreBtnIndex],fittingItemsWithMore=getFittingItemsCount(menuWidth-moreBtnWidth,lisWidths),fittingItemsCountWithoutMore=getFittingItemsCount(menuWidth,lisWidths),totalItemsCount=lisWidths.length-1,fittingItemsCount=fittingItemsCountWithoutMore===totalItemsCount?fittingItemsCountWithoutMore:fittingItemsWithMore,$moreBtn=$($lis[moreBtnIndex]),$moreBtnUl=$moreBtn.children('ul'),$itemsToMoveIntoMoreBtn=$lis.slice(fittingItemsCount,moreBtnIndex),menuHiddenClassName=$moreBtnUl.children().first().attr('class');if(fittingItemsCount<totalItemsCount){removeSeparatorFromLastItem($itemsToMoveIntoMoreBtn);$itemsToMoveIntoMoreBtn.attr('class',menuHiddenClassName);$moreBtnUl.children().remove();$itemsToMoveIntoMoreBtn.detach();$moreBtnUl.append($itemsToMoveIntoMoreBtn)}else{$moreBtn.remove();$($lis[moreBtnIndex-1]).find('.divider').remove()}})}function getParentLi($el){return $el.parents('li')[0]}function addExpandedClass($el){$el.addClass('expanded')}function removeExpandedClass($el){$el.removeClass('expanded')}function addHoverClass($el){$el.addClass('hover')}function removeHoverClass($el){$el.removeClass('hover')}function hasChildren($a){return $a.parent().find('ul').length!==0}function makeAttachExpandedClassesOnHoverForSelfAndParentA(subMenuLiClone){return function(a){var $a=$(a),aHasChildren=hasChildren($a),secondParentLi=getParentLi($(getParentLi($a))),$parentsA=[],currentParent=secondParentLi,counter=0;while(currentParent!==subMenuLiClone){if(counter>100){throw new Error('Can\'t find subMenuLiClone as parent')}var $currentParent=$(currentParent),parentA=$currentParent.find('> a'),$parentA=$(parentA);$parentsA.push($parentA);currentParent=getParentLi($currentParent);counter++}$a.mouseenter(function(){if(aHasChildren){addExpandedClass($a)}addHoverClass($a);$parentsA.forEach(function($el){addExpandedClass($el);addHoverClass($el)})});$a.mouseleave(function(){if(aHasChildren){removeExpandedClass($a)}removeHoverClass($a);$parentsA.forEach(function($el){removeExpandedClass($el);removeHoverClass($el)})})}}function fixDropdownMenus(){var menuDropdownSelector='div.menu.dropdown';$(menuDropdownSelector+' > ul > li').each(function(_,li){var $li=$(li),$a=$li.find('> a'),aHasChildren=hasChildren($a),expandableUl=$li.find('ul')[0];if(expandableUl){var contaierClassName=$li.parents(menuDropdownSelector).attr('class'),parentUlClassName=$li.parent('ul').attr('class'),$expandableUl=$(expandableUl),$containerClone=$(document.createElement('div'));$containerClone.css({position:'absolute',zIndex:10000,left:0,top:0,height:'0px',display:'block'});$containerClone.addClass(contaierClassName);var $subMenuUlClone=$(document.createElement('ul')),$subMenuLiClone=$(document.createElement('li')),subMenuLiClone=$subMenuLiClone[0],attachExpandedClassesOnHoverForSelfAndParentA=makeAttachExpandedClassesOnHoverForSelfAndParentA(subMenuLiClone);$subMenuUlClone.addClass(parentUlClassName);$subMenuLiClone.css('position','absolute');$containerClone.append($subMenuUlClone);$subMenuUlClone.append($subMenuLiClone);$(document.body).append($containerClone);var $expandableUlClone;$li.mouseenter(function(){if(aHasChildren){addExpandedClass($a)}addHoverClass($li);var expandableUlOffset=$expandableUl.offset();removeHoverClass($li);$containerClone.css({left:expandableUlOffset.left-parseInt($expandableUl.css('padding-left'),10),top:expandableUlOffset.top-parseInt($expandableUl.css('padding-top'),10)});$expandableUlClone=$expandableUl.clone();$subMenuLiClone.append($expandableUlClone);$subMenuLiClone.find('a').toArray().forEach(attachExpandedClassesOnHoverForSelfAndParentA);addHoverClass($subMenuLiClone);addHoverClass($a)});$li.mouseleave(function(e){removeExpandedClass($a);removeHoverClass($a);var inSubMenu=$.contains($containerClone[0],e.relatedTarget);if(!inSubMenu){if(aHasChildren){removeExpandedClass($a)}removeHoverClass($subMenuLiClone);$expandableUlClone.remove()}});$containerClone.mouseenter(function(){addExpandedClass($a);addHoverClass($a)});$containerClone.mouseleave(function(){removeExpandedClass($a);removeHoverClass($subMenuLiClone);removeHoverClass($a);$expandableUlClone.remove()})}})}fixMoreButtons();fixDropdownMenus()}(oneJQuery));